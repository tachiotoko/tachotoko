<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>キャラカード & HP管理（装備切替）</title>
  <style>
    :root{
      --bg:#0f0f12; --panel:#171a20; --line:#2a2f3a; --txt:#e9ecf1;
      --muted:#aab3c2; --red:#ef4444; --blue:#3b82f6; --btn:#222734;
      --gold:#eab308;
    }
    body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,sans-serif;}
    header{
      position:sticky;top:0;background:rgba(15,15,18,.92);backdrop-filter:blur(8px);
      border-bottom:1px solid var(--line);padding:10px 12px;z-index:10;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:var(--panel);font-size:12px;color:var(--muted);}
    select,button,input{font:inherit}
    select,button{border:1px solid var(--line);background:var(--btn);color:var(--txt);border-radius:10px;padding:10px 12px;}
    button{cursor:pointer}
    button:active{transform:translateY(1px)}
    .danger{border-color:#7f1d1d;background:#2a1212}
    .primary{border-color:#1e3a8a;background:#101b33}
    .equipOn{border-color:rgba(234,179,8,.55);background:rgba(234,179,8,.12)}
    main{padding:12px;display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:12px;}
    @media(min-width:720px){ main{grid-template-columns:repeat(2,minmax(0,1fr));} }
    .card{border:1px solid var(--line);background:var(--panel);border-radius:14px;padding:12px;}
    .equipped{box-shadow:0 0 0 2px rgba(234,179,8,.55) inset;}
    .top{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;}
    .name{font-size:18px;font-weight:800;margin:0}
    .sub{font-size:12px;color:var(--muted);margin-top:4px}
    .tag{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted);display:inline-block;}
    .tagGold{border-color:rgba(234,179,8,.55);color:rgba(255,231,140,.95);background:rgba(234,179,8,.10);}
    .teamR{border-color:rgba(239,68,68,.35)}
    .teamB{border-color:rgba(59,130,246,.35)}
    .statgrid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:10px;}
    .stat{border:1px solid var(--line);border-radius:12px;padding:8px;background:#12141a;}
    .k{font-size:11px;color:var(--muted)}
    .v{font-size:18px;font-weight:800;margin-top:2px}
    .hpbox{
      margin-top:10px;border:1px solid var(--line);border-radius:12px;padding:10px;
      background:#12141a;display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .hpLabel{font-size:12px;color:var(--muted)}
    .hpVal{font-size:28px;font-weight:900}
    .hpBtns{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;}
    .hpBtns button{min-width:54px}
    .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:space-between;margin-top:10px;}
    .small{font-size:11px;color:var(--muted)}
    .diff{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.4}
    .diff b{color:#fff}
  </style>
</head>
<body>
<header>
  <div class="row">
    <div class="row" style="gap:8px;">
      <div class="pill">スマホ用：5キャラHP管理</div>
      <div class="pill" id="hint">装備OFF(BASE)→宝箱ゲットで装備ON(GEAR)</div>
    </div>
    <div class="row">
      <label class="pill">
        チーム：
        <select id="teamSel">
          <option value="R">赤</option>
          <option value="B">青</option>
        </select>
      </label>
      <button id="resetHpBtn" class="danger">HPを最大に</button>
      <button id="resetAllBtn">全部初期化</button>
    </div>
  </div>
</header>

<main id="cards"></main>

<script>
/**
 * 目的：
 * - 装備前(BASE)でスタート
 * - 宝箱を取ったら「装備ボタン」で装備ON
 * - 装備ONでステータスがGEARに切り替わる
 *
 * 保存：
 * - HP と 装備状態(equipped) は端末内(localStorage)に保存
 */

const DATA = {
  R: [
    { key:"rabbit_hero", name:"いぬ勇者",  role:"勇者",
      BASE:{ HP:2, ATK:1, DEF:1, MOV:3 },  // 装備なし（弱い）
      GEAR:{ HP:6, ATK:3, DEF:3, MOV:3 }   // 装備あり（今の強い数値）
    },
    { key:"pig_tank", name:"きりん盾兵", role:"盾兵",
      BASE:{ HP:2, ATK:1, DEF:1, MOV:2 },
      GEAR:{ HP:5, ATK:2, DEF:4, MOV:2 }
    },
    { key:"snake_arch", name:"りゅう弓兵", role:"弓兵",
      BASE:{ HP:2, ATK:1, DEF:1, MOV:2 },
      GEAR:{ HP:5, ATK:2, DEF:2, MOV:4 }
    },
    { key:"ele_mage", name:"うし魔法使い", role:"魔法",
      BASE:{ HP:2, ATK:1, DEF:1, MOV:2 },
      GEAR:{ HP:5, ATK:3, DEF:2, MOV:3 }
    },
    { key:"lion_axe", name:"うま斧兵", role:"斧兵",
      BASE:{ HP:2, ATK:1, DEF:1, MOV:3 },
      GEAR:{ HP:5, ATK:4, DEF:1, MOV:2 }
    },
  ],
  B: [
    { key:"dog_hero", name:"うさぎ勇者", role:"勇者",
      BASE:{ HP:2, ATK:1, DEF:1, MOV:2 },
      GEAR:{ HP:6, ATK:3, DEF:3, MOV:3 }
    },
    { key:"gira_tank", name:"ぶた盾兵", role:"盾兵",
      BASE:{ HP:2, ATK:1, DEF:1, MOV:2 },
      GEAR:{ HP:5, ATK:2, DEF:4, MOV:2 }
    },
    { key:"dragon_arch", name:"へび弓兵", role:"弓兵",
      BASE:{ HP:2, ATK:1, DEF:1, MOV:3 },
      GEAR:{ HP:5, ATK:2, DEF:2, MOV:4 }
    },
    { key:"cow_mage", name:"ぞう魔法使い", role:"魔法",
      BASE:{ HP:2, ATK:1, DEF:1, MOV:2 },
      GEAR:{ HP:5, ATK:3, DEF:2, MOV:3 }
    },
    { key:"horse_axe", name:"らいおん斧兵", role:"斧兵",
      BASE:{ HP:2, ATK:1, DEF:1, MOV:3 },
      GEAR:{ HP:5, ATK:4, DEF:1, MOV:2 }
    },
  ]
};

const teamSel = document.getElementById("teamSel");
const cardsEl = document.getElementById("cards");
const resetHpBtn = document.getElementById("resetHpBtn");
const resetAllBtn = document.getElementById("resetAllBtn");

/* ===== 保存キー ===== */
function hpKey(team, charKey){ return `cm_board_hp_${team}_${charKey}`; }
function eqKey(team, charKey){ return `cm_board_eq_${team}_${charKey}`; }

/* ===== 装備状態 ===== */
function isEquipped(team, c){
  return localStorage.getItem(eqKey(team, c.key)) === "1";
}
function setEquipped(team, c, v){
  localStorage.setItem(eqKey(team, c.key), v ? "1" : "0");
}

/* ===== 現在ステータス ===== */
function curStats(team, c){
  return isEquipped(team, c) ? c.GEAR : c.BASE;
}

/* ===== HP ===== */
function getHp(team, c){
  const stats = curStats(team, c);
  const v = localStorage.getItem(hpKey(team, c.key));
  if (v === null) return stats.HP;
  const n = Number(v);
  if (!Number.isFinite(n)) return stats.HP;
  // 最大HPが装備で変わるので、はみ出したら丸める
  return clampHp(stats.HP, n);
}
function setHp(team, c, hp){
  localStorage.setItem(hpKey(team, c.key), String(hp));
}
function clampHp(maxHp, hp){
  if (hp < 0) hp = 0;
  if (hp > maxHp) hp = maxHp;
  return hp;
}

/* ===== 表示 ===== */
function diffText(base, gear){
  const f = (k) => {
    const b = base[k], g = gear[k];
    const d = g - b;
    if (d === 0) return `${k}: ${b} → ${g}`;
    const sign = d>0 ? "+" : "";
    return `${k}: ${b} → ${g}（${sign}${d}）`;
  };
  return `${f("HP")} / ${f("ATK")} / ${f("DEF")} / ${f("MOV")}`;
}

function render(){
  const team = teamSel.value;
  const list = DATA[team];
  cardsEl.innerHTML = "";

  for (const c of list){
    const equipped = isEquipped(team, c);
    const stats = curStats(team, c);
    const hp = getHp(team, c);

    const card = document.createElement("div");
    card.className = `card ${team==="R"?"teamR":"teamB"} ${equipped?"equipped":""}`;

    const teamName = team==="R" ? "赤" : "青";
    const eqTag = equipped ? `<span class="tag tagGold">装備中</span>` : `<span class="tag">装備なし</span>`;

    card.innerHTML = `
      <div class="top">
        <div>
          <p class="name">${c.name}</p>
          <div class="sub">${teamName}チーム / <span class="tag">${c.role}</span> ${eqTag}</div>
        </div>
        <div class="small">最大HP ${stats.HP}</div>
      </div>

      <div class="statgrid">
        <div class="stat"><div class="k">ATK</div><div class="v">${stats.ATK}</div></div>
        <div class="stat"><div class="k">DEF</div><div class="v">${stats.DEF}</div></div>
        <div class="stat"><div class="k">MOV</div><div class="v">${stats.MOV}</div></div>
        <div class="stat"><div class="k">状態</div><div class="v" style="font-size:14px">${equipped ? "装備あり" : "装備なし"}</div></div>
      </div>

      <div class="hpbox">
        <div>
          <div class="hpLabel">残りHP</div>
          <div class="hpVal" id="hp_${team}_${c.key}">${hp}</div>
        </div>
        <div class="hpBtns">
          <button data-delta="-5">-5</button>
          <button data-delta="-1">-1</button>
          <button data-delta="+1">+1</button>
          <button data-delta="+5">+5</button>
        </div>
      </div>

      <div class="actions">
        <button class="primary equipBtn ${equipped?"equipOn":""}">
          ${equipped ? "装備を外す（BASEへ）" : "装備する（GEARへ）"}
        </button>
        <button class="danger healBtn">HPを最大に</button>
      </div>

      <div class="diff">
        <b>装備差分</b><br>
        ${diffText(c.BASE, c.GEAR)}
      </div>
    `;

    // HPボタン
    card.querySelectorAll("button[data-delta]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const delta = Number(btn.getAttribute("data-delta"));
        const cur = getHp(team, c);
        const next = clampHp(stats.HP, cur + delta);
        setHp(team, c, next);
        document.getElementById(`hp_${team}_${c.key}`).textContent = String(next);
      });
    });

    // 装備切替ボタン
    card.querySelector(".equipBtn").addEventListener("click", ()=>{
      const now = isEquipped(team, c);
      setEquipped(team, c, !now);

      // 装備切替で最大HPが変わるので、HPを新最大に丸める（＆基本は最大に合わせる）
      const newStats = curStats(team, c);
      // 「宝箱取ったら全回復」にしたいならこれが自然
      setHp(team, c, newStats.HP);

      render();
    });

    // このキャラだけHP最大
    card.querySelector(".healBtn").addEventListener("click", ()=>{
      const s = curStats(team, c);
      setHp(team, c, s.HP);
      render();
    });

    cardsEl.appendChild(card);
  }
}

teamSel.addEventListener("change", render);

// チーム全員 HP 最大（現状態の最大HPへ）
resetHpBtn.addEventListener("click", ()=>{
  const team = teamSel.value;
  for (const c of DATA[team]){
    const s = curStats(team, c);
    setHp(team, c, s.HP);
  }
  render();
});

// 端末内の保存を全部消す（HPも装備状態も）
resetAllBtn.addEventListener("click", ()=>{
  for (const team of ["R","B"]){
    for (const c of DATA[team]){
      localStorage.removeItem(hpKey(team, c.key));
      localStorage.removeItem(eqKey(team, c.key));
    }
  }
  render();
});

// 初回表示
render();
</script>
</body>
</html>
